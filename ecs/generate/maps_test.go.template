{{- define "template" -}}
package ecs

// Code generated by go generate; DO NOT EDIT.

import (
	"testing"

	"github.com/stretchr/testify/assert"
)

{{range makeRange 1 8}}
{{- $n := . -}}
{{- $upper := upperLetters . -}}
{{- $lower := lowerLetters . -}}

{{- $generics := join "[Comp" ", Comp" "]" $upper -}}
{{- $args := arguments $lower $upper "Comp" -}}
{{- $mapArgs := join "&Comp" "{}, &Comp" "{}" $upper -}}
{{- $comps := join "" ", " "" $lower -}}

{{- $genericsRel := replace $generics "CompA" "ChildOf" -}}
{{- $mapArgsRel := replace $mapArgs "CompA" "ChildOf" -}}

func TestMap{{.}}(t *testing.T) {
	n := 12
	w := NewWorld(4)

	mapper := NewMap{{.}}{{$generics}}(&w)

	entities := []Entity{}
	for range n {
		e := mapper.NewEntity({{$mapArgs}})
		entities = append(entities, e)
		e = w.NewEntity()
		mapper.Add(e, {{$mapArgs}})
		entities = append(entities, e)
	}

	for _, e := range entities {
		{{blanks .}} = mapper.Get(e)
		assert.True(t, mapper.HasAll(e))
	}

	for _, e := range entities {
		mapper.Remove(e)
	}

	assert.Panics(t, func(){
		mapper.Get(Entity{})
	})
	assert.Panics(t, func(){
		mapper.HasAll(Entity{})
	})
	assert.Panics(t, func(){
		mapper.Add(Entity{}, {{$mapArgs}})
	})
	assert.Panics(t, func(){
		mapper.Remove(Entity{})
	})
}

func TestMap{{.}}NewBatch(t *testing.T) {
	n := 12
	w := NewWorld(8)

	mapper := NewMap{{.}}{{$generics}}(&w)

	for range n {
		_ = mapper.NewEntity({{$mapArgs}})
	}
	mapper.NewBatch(n*2, {{$mapArgs}})

	filter := NewFilter{{.}}{{$generics}}(&w)
	query := filter.Query()
	cnt := 0
	var lastEntity Entity
	for query.Next() {
		{{blanks .}} = query.Get()
		lastEntity = query.Entity()
		cnt++
	}
	assert.True(t, mapper.HasAll(lastEntity))
	assert.Equal(t, n*3, cnt)
}

func TestMap{{.}}NewBatchFn(t *testing.T) {
	n := 12
	w := NewWorld(8)

	mapper := NewMap{{.}}{{$generics}}(&w)

	for range n {
		_ = mapper.NewEntity({{$mapArgs}})
	}
	mapper.NewBatchFn(2*n, func(entity Entity, {{$args}}) {
		a.X = 5
		a.Y = 6
	})

	filter := NewFilter{{.}}{{$generics}}(&w)
	query := filter.Query()
	cnt := 0
	var lastEntity Entity
	for query.Next() {
		{{blanks .}} = query.Get()
		lastEntity = query.Entity()
		cnt++
	}
	assert.True(t, mapper.HasAll(lastEntity))
	assert.Equal(t, 3*n, cnt)
}

func TestMap{{.}}Relations(t *testing.T) {
	w := NewWorld(8)

	mapper := NewMap{{.}}{{$genericsRel}}(&w)

	parent1 := w.NewEntity()
	parent2 := w.NewEntity()

	e := mapper.NewEntity({{$mapArgsRel}}, Rel(0, parent1))
	assert.Equal(t, parent1, mapper.GetRelation(e, 0))
	assert.Equal(t, parent1, mapper.GetRelationUnchecked(e, 0))

	mapper.SetRelations(e, Rel(0, parent2))
	assert.Equal(t, parent2, mapper.GetRelation(e, 0))

	assert.Panics(t, func(){
		mapper.SetRelations(Entity{}, Rel(0, parent2))
	})
	assert.Panics(t, func(){
		mapper.GetRelation(Entity{}, 0)
	})
}

{{end -}}
{{end -}}
