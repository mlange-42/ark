{{- define "template" -}}
package ecs

// Code generated by go generate; DO NOT EDIT.

import "testing"

{{range makeRange 1 4}}
{{- $n := . -}}
{{- $upper := upperLetters . -}}
{{- $lower := lowerLetters . -}}

{{- $generics := join "[Comp" ", Comp" "]" $upper -}}
{{- $args := arguments $lower $upper "" "Comp" -}}

func TestObserve{{.}}(t *testing.T) {
	w := NewWorld()
	var obs *Observer{{.}}{{$generics}}
	obs = obs.New(OnAddComponents).Do(func(e Entity, {{$args}}) {}).Register(&w)

	expectPanicsWithValue(t, "can't modify a registered observer",
		func() {
			obs.For(C[Position]())
		})
	expectPanicsWithValue(t, "can't modify a registered observer",
		func() {
			obs.With(C[Position]())
		})
	expectPanicsWithValue(t, "can't modify a registered observer",
		func() {
			obs.Without(C[Position]())
		})
	expectPanicsWithValue(t, "can't modify a registered observer",
		func() {
			obs.Exclusive()
		})

	expectPanicsWithValue(t, "observer callback must be set via Do before registering",
		func() {
			Observe{{.}}{{$generics}}(OnCreateEntity).Register(&w)
		})
	expectPanicsWithValue(t, "observer already has a callback",
		func() {
			Observe{{.}}{{$generics}}(OnCreateEntity).
				Do(func(e Entity, {{$args}}) {}).
				Do(func(e Entity, {{$args}}) {})
		})

	obs = Observe{{.}}{{$generics}}(OnAddComponents).Do(func(e Entity, {{$args}}) {})

	obs.For()
	expectEqual(t, 0, len(obs.comps))

	obs.For(C[Position]())
	expectEqual(t, 1, len(obs.comps))

	obs = Observe{{.}}{{$generics}}(OnAddComponents).With().Do(func(e Entity, {{$args}}) {}).Register(&w)
	expectEqual(t, 0, len(obs.observer.with))
	expectFalse(t, obs.observer.hasWith)

	obs = Observe{{.}}{{$generics}}(OnAddComponents).With(C[Position]()).Do(func(e Entity, {{$args}}) {}).Register(&w)
	expectEqual(t, 1, len(obs.observer.with))
	expectTrue(t, obs.observer.hasWith)

	obs = Observe{{.}}{{$generics}}(OnAddComponents).Without().Do(func(e Entity, {{$args}}) {}).Register(&w)
	expectEqual(t, 0, len(obs.observer.without))
	expectFalse(t, obs.observer.hasWithout)

	obs = Observe{{.}}{{$generics}}(OnAddComponents).Without(C[Position]()).Do(func(e Entity, {{$args}}) {}).Register(&w)
	expectEqual(t, 1, len(obs.observer.without))
	expectTrue(t, obs.observer.hasWithout)

	obs = Observe{{.}}{{$generics}}(OnAddComponents).For(C[Position]()).Do(func(e Entity, {{$args}}) {}).Register(&w)
	expectEqual(t, {{.}} + 1, len(obs.observer.comps))
	expectTrue(t, obs.observer.hasComps)
	
	obs.Unregister(&w)
	obs.Register(&w)
	expectEqual(t, {{.}} + 1, len(obs.observer.comps))
	expectTrue(t, obs.observer.hasComps)
}

func TestObserver{{.}}Register(t *testing.T) {
	w := NewWorld()

	obs1 := Observe{{.}}{{$generics}}(OnCreateEntity).
		With(C[Position]()).
		Without(C[Heading]()).
		Do(func(e Entity, {{$args}}) {}).
		Register(&w)
	expectTrue(t, w.storage.observers.HasObservers(OnCreateEntity))

	obs2 := Observe{{.}}{{$generics}}(OnCreateEntity).
		With(C[Position]()).
		Do(func(e Entity, {{$args}}) {}).
		Register(&w)

	expectPanicsWithValue(t, "observer is already registered",
		func() {
			obs1.Register(&w)
		})

	obs1.Unregister(&w)
	expectTrue(t, w.storage.observers.HasObservers(OnCreateEntity))
	obs2.Unregister(&w)
	expectFalse(t, w.storage.observers.HasObservers(OnCreateEntity))
}

func TestObserver{{.}}Callback(t *testing.T) {
	w := NewWorld()
	builder := NewMap{{.}}{{$generics}}(&w)

	Observe{{.}}{{$generics}}(OnCreateEntity).
		Do(func(e Entity, {{$args}}) {
			expectEqual(t, CompA{}, *a)
		}).
		Register(&w)

	builder.NewEntity(
        {{- range $i, $v := $upper}}
		&Comp{{$v}}{},
        {{- end}}
	)
}

{{end -}}
{{end -}}